Gherkin compiler for Drupal

At the heart of Behavior-Driven Development (BDD) is a rethinking of the approach to unit testing and acceptance testing. The Gherkin language is a formal English-language description of business specifications, that can be compiled automatically into acceptance tests. Business stakeholders and developers work together to formulate these statements of what the software should do. Features are described using the standard Agile framework of a User story for each feature: 

Feature: [Short name of feature]
  As a [role] 
  I want [feature] 
  So [benefit]
# [additional description]

Acceptance criteria are written in terms of one or more scenarios for each feature:

Scenario: [Short name of scenario]
  Given [initial context]
  And [additional context line(s)]
  When [event occurs]
  And [addition event(s) occur]
  Then [expected outcome]
  And [additional expected outcome(s)]
# [additional description]

All the "additional" lines can be multiple or omitted.
Comment lines (beginning with '#') can appear anywhere.
This Gherkin compiler makes several extensions to the standard Gherkin language:
 * You can include a "Variants" section after the Feature header, consisting of a single multi-line argument
   whose first line is a list of values to be replaced and each subsequent line is a list of replacements.
   The whole series of tests will be run as-is, then with each list of replacements.
   You can use double quotes in Variant lines, without having to use doubled single quotes.
 * You can include a special first scenario headed "Setup:" instead of "Scenario:" that will be run
   at the start of each scenario to set things up. Typically this will include "Given" (and "And" or "When") statements,
   but you can also include "Then"s (and "And"s) to test the setup.
 * In addition to numbers and double-quoted strings as function arguments, you can have punctuated numbers
   like 222-333-4444 or $34,526.87 or +1800.222.3333 or #43-2-1111.
   Dollar signs and commas are ignored. Everything else is included as part of the argument.
 * You can also use magic "%" arguments like the following:
	   %random (or %whatever) - a random-length, random string of characters without double quotes or percents
	   %random3 (or %whatever3) - same as above. The string will stay the same for a whole scenario. Use any integer up to 3.
	   %phone5 (or %number) - a random US phone number like +12223334444 (only "number" is implemented, not "phone")
	   %today - today's date, formatted 
	   %today-15d - 15 days ago
	   %today-15w - 15 weeks ago
	   %today-15m - 15 months ago
	   %today+15d - 15 days from now (not implemented)
	   %picture1 - a random picture (will be saved in path $picturePath, so be sure to create that global)
	   %CONSTANT_NAME - any defined constant (document any use of these, in the feature header, unless they self-explain)
    To adjust the magic constants $subs array, create a file in your program directory called "usualSubs.inc".
	For example, after the <?php tag, your usualSubs.inc file could say: 
	  $fruits = array('apple', 'banana', 'cherry');
	  $subs['%fruit'] = $fruits[random(0, 2)];
	Magic "%" arguments also work within other arguments, including multi-line arguments
  * Any argument can be an array. Use "=>" to indicate a subvalue (for example a selected option) and separate subvalues with commas, like in an array definition, without the quotes. For example "first=>this,second=>that" produces an argument whose value is: array('first' => 'this', 'second' => 'that').

_____________________________________________________________________________________

Create and place your Gherkin-language feature files in a directory called "features" -- ideally in your program directory.
If your program directory is "zot", it should contain the following files and directorys:
  zot.info (modified by the Gherkin compiler)
  features directory
  test directory (created and populated automatically by the Gherkin compiler)
  other files and directories for your module 
  (any subdirectories for subsidiary modules will need their own gherkin, features, and test directories)

When you create a feature, name the file after the feature using punctuationless titlecase 
-- for example, "PageTiltsWhenIPressEnter.feature" -- and save it in the features folder.

To run the compiler, browse to path/gherkin/compiler.php?your_program_directory

This will (if all goes well), create a test directory and, for each feature, a test in
the test directory -- called, for example, "PageTiltsWhenIPressEnter.test".
You shouldn't ever need to alter these test files (except for occasionally inserting debugging statements) except by rerunning the Gherkin compiler.

The compiler will create a steps file in your program directory, called "zot.steps", if your program directory is zot.

If your program is a Drupal module, the compiler will automatically include a reference to the created tests,
in your module's .info file (for example, files[] = PageTiltsWhenIPressEnter.test).

Your job then is to change all the "todo"s in the steps file, as needed.
Each step function should return TRUE if the step's assertion is true (otherwise FALSE);
If the global variable $testOnly is TRUE, the step function should only test the assertion.
Otherwise, it should MAKE the assertion be true by setting up the appropriate conditions, then return TRUE.

For example, if you have a step function called "accountExists", then:
* When the step function is called from Given("account 5 exists"),
  the step function should create the account if it doesn't exist yet.
* However, when the step function is called from Then("account 5 exists"), 
  just return FALSE if the account does not exist.

If you modify a feature file, rerun the compiler to recreate all the test files.
The .steps file will also be updated accordingly, but the compiler will never change the inside of any step function.
In fact, the compiler will never change anything in the steps file exept the comments immediately preceding the step functions.
And the compiler will add new functions (and preceding comments) to the end of the steps file.
YOU should not change anything in the steps file EXCEPT the header comments and what is inside the step functions.

Once you have finished coding the steps,
run the tests in Drupal using one of these two methods:
  1. (The slow, hard-to-debug, thorough way):
     Browse to /admin/config/development/testing
     Click to put a check mark by your test and click the "Run tests" button.
     After several minutes, the "todo"s will show up in yellow as well as failing (which appear in red).
  2. (The FAST, easy to debug way):
     Copy path/gherkin/test.php to your program directory.
     Browse to path_to_your_program_directory/test.php?feature_name

Of course your final task is to make all the tests return TRUE and turn green, by making the module
actually do what is being tested.

Need help? Ask William: wspademan@gmail.com

Have fun.
